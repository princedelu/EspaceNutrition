/*! EspaceNutrition 30-08-2014 */
angular.module("underscore",[]).factory("_",function(){return window._}),angular.module("EspaceNutrition",["ngRoute","underscore"]).config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){var access=routingConfig.accessLevels;$routeProvider.when("/",{templateUrl:"/partials/public.php",controller:"EspaceNutritionPublicCtrl",access:access.public}),$routeProvider.when("/paiementSuccess",{templateUrl:"/partials/public.php",controller:"EspaceNutritionPublicCtrl",action:"paiementSuccess",access:access.public}),$routeProvider.when("/login",{templateUrl:"/partials/login.html",controller:"EspaceNutritionCtrl",access:access.public}),$routeProvider.when("/dashboard",{templateUrl:"/partials/admin/dashboard.php",controller:"EspaceNutritionCtrl",access:access.user}),$routeProvider.when("/utilisateurs",{templateUrl:"/partials/admin/utilisateurs.php",controller:"UtilisateurCtrl",action:"listUtilisateur",access:access.admin}),$routeProvider.when("/404",{templateUrl:"/partials/404.html",access:access.public}),$routeProvider.otherwise({redirectTo:"/404"}),$locationProvider.html5Mode(!0).hashPrefix("!"),$httpProvider.interceptors.push(function($q,$location,$window){return{request:function(config){return config.headers=config.headers||{},$window.sessionStorage.token&&(config.headers.Authorization="Bearer "+$window.sessionStorage.token),config},responseError:function(response){return 401===response.status?($location.path("/login"),$q.reject(response)):$q.reject(response)}}})}]).run(["$rootScope","$location","$window","Auth",function($rootScope,$location,$window,Auth){$rootScope.$on("$routeChangeStart",function(event,next,current){$rootScope.error=null,void 0!==current&&void 0!==current.$$route&&($rootScope[current.$$route.originalPath.split("/")[1]]=!1),void 0!==next&&void 0!==next.$$route&&($rootScope[next.$$route.originalPath.split("/")[1]]=!0),Auth.authorize(next.access)||$location.path(Auth.isLoggedIn()?"/dashboard":"/login")})}]),function(){"use strict";angular.module("EspaceNutrition").controller("EspaceNutritionCtrl",["$rootScope","$scope","$location","$route","$window","Auth","UtilisateurFactory",function($rootScope,$scope,$location,$route,$window,Auth){$scope.user=Auth.user,$scope.userRoles=Auth.userRoles,$scope.accessLevels=Auth.accessLevels,$scope.role="1",void 0!==$location.search().token?$scope.token=$location.search().token:$scope.confirmpassword="value",$scope.logout=function(){delete $window.sessionStorage.token,$location.path("/login")},$scope.login=function(){void 0===$scope.token?Auth.login({email:$scope.email,password:$scope.password},function(res){$window.sessionStorage.token=res,$location.path("/dashboard")},function(err){$scope.error=err}):$scope.password!=$scope.confirmpassword?$scope.error="Les mots de passe ne sont pas identiques":Auth.modificationPassword({email:$scope.email,password:$scope.password,token:$scope.token},function(res){$window.sessionStorage.token=res,$location.path("/dashboard")},function(err){$scope.error=err})},$scope.go=function(path){$window.location.href=path},$scope.demandeChangementPassword=function(){$scope.success="",$scope.error="",void 0===$scope.email?$scope.error="Veuillez saisir votre email":Auth.sendMailToken({email:$scope.email},function(){$scope.success="Un mail a été envoyé à l adresse ci-dessous afin de modifier votre mot de passe"},function(err){$scope.error=err})},$scope.monprofilLoad=function(){$scope.success="",$scope.error="",Auth.get(function(res){$scope.email=res.EMAIL,$scope.nom=res.NOM,$scope.prenom=res.PRENOM,$scope.datenaissance=res.DATENAISSANCE,$scope.id=res.ID,$scope.success="Succes",$("#dateNaissanceProfil").datepicker({format:"dd-mm-yyyy"}),$("#bs-profil").modal("show")},function(err){$scope.error=err})},$scope.updateProfil=function(){if($scope.success="",$scope.error="",$scope.password!=$scope.passwordConfirm)$scope.error="Les mots de passe ne sont pas identiques";else{var objetValue={};objetValue.email=$scope.email,objetValue.nom=$scope.nom,objetValue.password=$scope.password,objetValue.prenom=$scope.prenom,objetValue.datenaissance=$scope.datenaissance,objetValue.id=$scope.id,objetValue.profil=1,Auth.post(objetValue,function(){$scope.success="Succes",$("#bs-profil").modal("hide")},function(err){$scope.error=err})}},$scope.offcanvas=function(){$(window).width()<=992?($(".row-offcanvas").toggleClass("active"),$(".left-side").removeClass("collapse-left"),$(".right-side").removeClass("strech"),$(".row-offcanvas").toggleClass("relative")):($(".left-side").toggleClass("collapse-left"),$(".right-side").toggleClass("strech"))}}])}(),function(){"use strict";angular.module("EspaceNutrition").directive("accessLevel",["Auth",function(Auth){return{restrict:"A",link:function($scope,element,attrs){function updateCSS(){userRole&&accessLevel&&(Auth.authorize(accessLevel,userRole)?element.css("display",prevDisp):element.css("display","none"))}var userRole,accessLevel,prevDisp=element.css("display");$scope.user=Auth.user,$scope.$watch("user",function(user){user.role&&(userRole=user.role),updateCSS()},!0),attrs.$observe("accessLevel",function(al){al&&(accessLevel=$scope.$eval(al)),updateCSS()})}}}]),angular.module("EspaceNutrition").directive("activeNav",["$location",function($location){return{restrict:"A",link:function(scope,element){var nestedA=element.find("a")[0],path=nestedA.href;scope.location=$location,scope.$watch("location.absUrl()",function(newPath){path===newPath?element.addClass("active"):element.removeClass("active")})}}}])}(),function(){"use strict";$(function(){$(".page-scroll a").bind("click",function(event){var $anchor=$(this);$("html, body").stop().animate({scrollTop:$($anchor.attr("href")).offset().top},1500,"easeInOutExpo"),event.preventDefault()})}),$(function(){$("body").on("input propertychange",".floating-label-form-group",function(e){$(this).toggleClass("floating-label-form-group-with-value",!!$(e.target).val())}).on("focus",".floating-label-form-group",function(){$(this).addClass("floating-label-form-group-with-focus")}).on("blur",".floating-label-form-group",function(){$(this).removeClass("floating-label-form-group-with-focus")})}),$("body").scrollspy({target:".navbar-fixed-top"}),$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()})}(),function(exports){function buildRoles(roles){var bitMask="01",userRoles={};for(var role in roles){var intCode=parseInt(bitMask,2);userRoles[roles[role]]={bitMask:intCode,title:roles[role]},bitMask=(intCode<<1).toString(2)}return userRoles}function buildAccessLevels(accessLevelDeclarations,userRoles){var accessLevels={};for(var level in accessLevelDeclarations){var role,resultBitMask="";if("string"==typeof accessLevelDeclarations[level])if("*"==accessLevelDeclarations[level]){for(role in userRoles)resultBitMask+="1";accessLevels[level]={bitMask:parseInt(resultBitMask,2),title:accessLevelDeclarations[level]}}else console.log("Access Control Error: Could not parse '"+accessLevelDeclarations[level]+"' as access definition for level '"+level+"'");else{resultBitMask=0;for(role in accessLevelDeclarations[level])userRoles.hasOwnProperty(accessLevelDeclarations[level][role])?resultBitMask|=userRoles[accessLevelDeclarations[level][role]].bitMask:console.log("Access Control Error: Could not find role '"+accessLevelDeclarations[level][role]+"' in registered roles while building access for '"+level+"'");accessLevels[level]={bitMask:resultBitMask,title:accessLevelDeclarations[level][role]}}}return accessLevels}var config={roles:["public","user","admin"],accessLevels:{"public":"*",anon:["public"],user:["user","admin"],admin:["admin"]}};exports.userRoles=buildRoles(config.roles),exports.accessLevels=buildAccessLevels(config.accessLevels,exports.userRoles),exports.publicKey="-----BEGIN PUBLIC KEY-----\nMIIBITANBgkqhkiG9w0BAQEFAAOCAQ4AMIIBCQKCAQBZQM9sX8M0PBHlNYO5iyHW\n/0La4UUIfLh1DlMy1lnyqlfLlRZCsyUkhzRaEAL5xrgo5qJFQvM3+CRYj4haaI4i\nGOvGe7CkdBgqGKR8EOtxHKO5lze5h474dcQodKUdK3YRpwu85fqQ8DRunTYt8O59\n+eIJhchW0tVP0LdT/x2nT9aFzxQh8g6yHT7ym4t5GrIjsapRsGZU7X0pH585HV2D\n/qpgfgnyL3sEHvN9vMRKIz+cj2JsAPu6w5s/j1hDVXvxF+C5tFYrvom9LF8C6cpQ\nPHzhI0hKAYEsV5psGqn1j1t7HA2+iSMsdPUEQqgM+IUoLaTGDFpQtgHmYi392UiB\nAgMBAAE=\n-----END PUBLIC KEY-----",exports.paypal={},exports.paypal.business="admin@espace-nutrition.fr",exports.paypal.urlReturn="http://espace-nutrition.fr/paiementSuccess",exports.paypal.urlCancel="http://espace-nutrition.fr",exports.paypal.urlNotify="http://espace-nutrition.fr/api",exports.paypal.sandbox=!0,exports.item={},exports.item[1]={},exports.item[1].libelle="EspaceNutrition - Consultation en ligne",exports.item[1].amount="50",exports.item[2]={},exports.item[2].libelle="EspaceNutrition - Suivi en ligne",exports.item[2].amount="80",exports.item[3]={},exports.item[3].libelle="EspaceNutrition - Consultation et suivi en ligne",exports.item[3].amount="100"}("undefined"==typeof exports?this.routingConfig={}:exports),function(){"use strict";angular.module("EspaceNutrition").factory("Auth",["$http","$window",function($http,$window){function changeUser(user){_.extend(currentUser,user)}function verifyToken(token){var isValid=!1;try{isValid=KJUR.jws.JWS.verify(token,publicKey)}catch(ex){isValid=!1}return isValid}function adaptUser(token){var result={email:"",role:userRoles.public};if(void 0!==token&&verifyToken(token)){var roleUser,a=token.split("."),uClaim=b64utos(a[1]),pClaim=KJUR.jws.JWS.readSafeJSONString(uClaim);roleUser=1==pClaim.role?userRoles.user:2==pClaim.role?userRoles.admin:userRoles.public,result={email:pClaim.email,role:roleUser}}return result}{var accessLevels=routingConfig.accessLevels,userRoles=routingConfig.userRoles,publicKey=routingConfig.publicKey,currentUser=adaptUser($window.sessionStorage.token);userRoles.public}return{authorize:function(accessLevel,role){return void 0===accessLevel&&(accessLevel=userRoles.admin),void 0===role&&(role=currentUser.role),accessLevel.bitMask&role.bitMask},isLoggedIn:function(user){return void 0===user&&(user=currentUser),verifyToken($window.sessionStorage.token)&&(user.role.title==userRoles.user.title||user.role.title==userRoles.admin.title)},login:function(user,success,error){$http.post("/api/login",user).success(function(token){var adaptedUser=adaptUser(token.value);changeUser(adaptedUser),success(token.value)}).error(error)},modificationPassword:function(user,success,error){$http.post("/api/modificationPassword",user).success(function(token){adaptUser(token.value);success(token.value)}).error(error)},sendMailToken:function(user,success,error){$http.post("/api/sendMailToken",user).success(success).error(error)},post:function(objet,success,error){$http.post("/api/utilisateur",objet).success(success).error(error)},get:function(success,error){$http.get("/api/profil").success(success).error(error)},accessLevels:accessLevels,userRoles:userRoles,user:currentUser}}])}(),function(){"use strict";angular.module("EspaceNutrition").controller("EspaceNutritionPublicCtrl",["$rootScope","$scope","$location","$route","$window",function($rootScope,$scope,$location,$route,$window){var action="";switch(void 0!==$route&&$route.current&&void 0!==$route.current.action&&(action=$route.current.action),$scope.affichePopupPaiement=function(id){$scope.success="",$scope.error="",$scope.idPaiement=id,$("#bs-paiement").modal("show")},$scope.redirectionPaiement=function(){$("#bs-paiement").modal("hide");var paramRedirect="";paramRedirect=paramRedirect+"?business="+routingConfig.paypal.business,paramRedirect=paramRedirect+"&item_name="+routingConfig.item[$scope.idPaiement].libelle,paramRedirect=paramRedirect+"&amount="+routingConfig.item[$scope.idPaiement].amount,paramRedirect+="&cmd=_xclick",paramRedirect+="&no_note=1",paramRedirect+="&lc=FR",paramRedirect+="&currency_code=EUR",paramRedirect+="&bn=EspaceNutrition_BuyNow_WPS_FR",paramRedirect=paramRedirect+"&first_name="+$scope.prenom,paramRedirect=paramRedirect+"&last_name="+$scope.nom,paramRedirect=paramRedirect+"&payer_email="+$scope.email,paramRedirect+="&item_number=1",paramRedirect=paramRedirect+"&return="+routingConfig.paypal.urlReturn,paramRedirect=paramRedirect+"&cancel_return="+routingConfig.paypal.urlCancel,paramRedirect=paramRedirect+"&notify_url="+routingConfig.paypal.urlNotify;var baseURL="https://www.";routingConfig.paypal.sandbox===!0&&(baseURL+="sandbox."),baseURL+="paypal.com/cgi-bin/webscr",$window.location.href=baseURL+encodeURI(paramRedirect)},$scope.paiementSuccess=function(){void 0===$rootScope.affichePopup&&($("#bs-paiementSuccess").modal("show"),$rootScope.affichePopup=!1)},action){case"listPrestations":$scope.listPrestations();break;case"paiementSuccess":$scope.paiementSuccess()}}])}(),function(){"use strict";angular.module("EspaceNutrition").controller("UtilisateurCtrl",["$rootScope","$scope","$location","$route","$window","Auth","UtilisateurFactory",function($rootScope,$scope,$location,$route,$window,Auth,UtilisateurFactory){$scope.user=Auth.user,$scope.userRoles=Auth.userRoles,$scope.accessLevels=Auth.accessLevels;var action="";switch(void 0!==$route&&$route.current&&void 0!==$route.current.action&&(action=$route.current.action),$scope.role="1",$scope.supprimer=function(id){$scope.success="",$scope.error="";var retVal=confirm("Voulez vous supprimer cet utilisateur?");retVal===!0&&UtilisateurFactory.supprimer(id,function(){$scope.success="Succes",$route.reload()},function(err){$scope.error=err,$route.reload()})},$scope.updateLoad=function(id){$scope.success="",$scope.error="",UtilisateurFactory.get(id,function(res){$scope.email=res.EMAIL,$scope.nom=res.NOM,$scope.prenom=res.PRENOM,$scope.datenaissance=res.DATENAISSANCE,$scope.role=res.ROLE,$scope.actif=res.ACTIF,$scope.id=res.ID,$scope.success="Succes",$("#dateNaissanceUtilisateur").datepicker({format:"dd-mm-yyyy"}),$("#bs-ajoututilisateur").modal("show")},function(err){$scope.error=err})},$scope.createLoad=function(){$scope.success="",$scope.error="",$scope.email="",$scope.nom="",$scope.prenom="",$scope.datenaissance="",$scope.role=1,$scope.id="",$("#dateNaissanceUtilisateur").datepicker({format:"dd-mm-yyyy"}),$("#bs-ajoututilisateur").modal("show")},$scope.add=function(){$scope.success="",$scope.error="",$scope.doublon="false";var objetValue={};objetValue.email=$scope.email,objetValue.nom=$scope.nom,objetValue.prenom=$scope.prenom,objetValue.datenaissance=$scope.datenaissance,objetValue.role=$scope.role,""===$scope.id?UtilisateurFactory.put(objetValue,function(){$scope.success="Succes",$("#bs-ajoututilisateur").on("hidden.bs.modal",function(){$route.reload()}),$("#bs-ajoututilisateur").modal("hide")},function(err){$scope.error=err,"Doublon"==err&&($scope.doublon="true")}):(objetValue.id=$scope.id,objetValue.actif=$scope.actif,UtilisateurFactory.post(objetValue,function(){$scope.success="Succes",$("#bs-ajoututilisateur").on("hidden.bs.modal",function(){$route.reload()}),$("#bs-ajoututilisateur").modal("hide")},function(err){$scope.error=err,"Doublon"==err&&($scope.doublon="true")}))},$scope.listUtilisateur=function(){$scope.success="",$scope.error="",$scope.loading=!0,UtilisateurFactory.list(function(res){$scope.loading=!1;{var data=$.map(res,function(el){return[[el.id,el.email,el.nom,el.prenom,el.role,el.actif,""]]});$("#utilisateurs").dataTable({aaData:data,aoColumns:[{sTitle:"Id"},{sTitle:"Email"},{sTitle:"Nom"},{sTitle:"Prénom"},{sTitle:"Role"},{sTitle:"Actif"},{sTitle:"Action"}],oLanguage:{sSearch:"Recherche:",sZeroRecords:"Pas d'éléménts à afficher",sInfo:"_START_ sur _END_ de _TOTAL_ éléments",sInfoEmpty:"Pas d'éléments",sInfoFiltered:" - filtrés sur _MAX_ éléments",sLengthMenu:"Afficher _MENU_ éléments",oPaginate:{sFirst:"Premier",sLast:"Dernier",sNext:"Suivant",sPrevious:"Précédent"}},aoColumnDefs:[{targets:0,visible:!1,searchable:!1},{targets:4,sType:"html",render:function(data){var spanOuv="&lt;span class=&quot;label ",label="";switch(data){case"0":label="label-danger&quot;&gt;Non autorisé";break;case"1":label="label-info&quot;&gt;Utilisateur";break;default:label="label-success&quot;&gt;Admin"}var spanFerm="&lt;/span&gt;",result=spanOuv.concat(label).concat(spanFerm);return $("<div/>").html(result).text()}},{targets:5,sType:"html",render:function(data){var spanOuv="&lt;span class=&quot;label ",label="";switch(data){case"0":label="label-info&quot;&gt;Non actif";break;case"1":label="label-success&quot;&gt;Actif";break;default:label="label-danger&quot;&gt;???"}var spanFerm="&lt;/span&gt;",result=spanOuv.concat(label).concat(spanFerm);return $("<div/>").html(result).text()}},{aTargets:[6],sType:"html",render:function(data,type,row){var result="",resultTmp="",id="",fin="";return resultTmp="&lt;button class=&quot;btn btn-link&quot; ng-click=&quot;update(",id=row[0],fin=")&quot; type=&quot;button&quot;&gt;&lt;span class=&quot;fa fa-pencil&quot;&gt;&lt;/span&gt;&lt;/button&gt;",result=resultTmp.concat(id).concat(fin),$scope.user.email!=row[1]&&(resultTmp="&lt;button class=&quot;btn btn-link app-btn-delete&quot; ng-click=&quot;delete(",id=row[0],fin=")&quot; type=&quot;button&quot;&gt;&lt;span class=&quot;fa fa-times&quot;&gt;&lt;/span&gt;&lt;/button&gt;",result=result.concat(resultTmp).concat(id).concat(fin)),$("<div/>").html(result).text()}}]})}$("#utilisateurs tbody").on("click","button",function(){var name=this.attributes[1].nodeName,value=this.attributes[1].nodeValue,tab="",result="";"ng-click"==name&&-1!=value.indexOf("delete")&&(tab=value.split("("),result=tab[1],tab=result.split(")"),result=tab[0],$scope.supprimer(result)),"ng-click"==name&&-1!=value.indexOf("update")&&(tab=value.split("("),result=tab[1],tab=result.split(")"),result=tab[0],$scope.updateLoad(result))})},function(){$scope.error="Impossible de recuperer les utilisateurs",$scope.loading=!1})},action){case"listUtilisateur":$scope.listUtilisateur()}}])}(),function(){"use strict";angular.module("EspaceNutrition").factory("UtilisateurFactory",["$http",function($http){var userRoles=routingConfig.userRoles;return{list:function(success,error){$http.get("/api/utilisateurs").success(success).error(error)},add:function(objet,success,error){$http.post("/api/utilisateur",objet).success(success).error(error)},get:function(id,success,error){$http.get("/api/utilisateur/"+id).success(success).error(error)},supprimer:function(id,success,error){$http({method:"DELETE",url:"/api/utilisateur/"+id}).success(success).error(error)},put:function(objet,success,error){$http.put("/api/utilisateur",objet).success(success).error(error)},post:function(objet,success,error){$http.post("/api/utilisateur",objet).success(success).error(error)},userRoles:userRoles}}])}();